<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Pagos - Conjunto Habitacional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .slide-in { animation: slideIn 0.3s ease-out; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6 slide-in">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">üíº Sistema de Pagos</h1>
                    <p class="text-gray-600 mt-1">Gesti√≥n de Copropietarios - Conjunto Habitacional</p>
                    <div class="mt-2 text-sm text-green-600 font-semibold">üü¢ Conectado a Base de Datos</div>
                </div>
                <div class="text-right">
                    <div class="text-sm text-gray-500">Total Copropietarios</div>
                    <div class="text-3xl font-bold text-indigo-600" id="totalCopropietarios">0</div>
                </div>
            </div>
        </div>

        <!-- Tabs Navigation -->
        <div class="bg-white rounded-2xl shadow-lg mb-6 slide-in" style="animation-delay: 0.1s;">
            <div class="flex flex-wrap border-b">
                <button id="tab-registro" class="flex-1 px-4 py-4 font-semibold text-indigo-600 border-b-2 border-indigo-600 min-w-[120px]">
                    üìù Registrar Pago
                </button>
                <button id="tab-copropietarios" class="flex-1 px-4 py-4 font-semibold text-gray-500 hover:text-gray-700 min-w-[120px]">
                    üë• Copropietarios
                </button>
                <button id="tab-gestion" class="flex-1 px-4 py-4 font-semibold text-gray-500 hover:text-gray-700 min-w-[120px]">
                    üîß Gesti√≥n Mensual
                </button>
                <button id="tab-deudores" class="flex-1 px-4 py-4 font-semibold text-gray-500 hover:text-gray-700 min-w-[120px]">
                    ‚ö†Ô∏è Deudores
                </button>
                <button id="tab-historial" class="flex-1 px-4 py-4 font-semibold text-gray-500 hover:text-gray-700 min-w-[120px]">
                    üìä Historial
                </button>
                <button id="tab-resumen" class="flex-1 px-4 py-4 font-semibold text-gray-500 hover:text-gray-700 min-w-[120px]">
                    üìà Resumen
                </button>
            </div>
        </div>

        <!-- Tab: Registrar Pago -->
        <div id="content-registro" class="space-y-6">
            <div class="bg-white rounded-2xl shadow-lg p-6 slide-in">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Registrar Nuevo Pago</h2>
                <form id="formPago" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Departamento *</label>
                            <select id="selectDepartamento" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                <option value="">Seleccione un departamento</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Nombre Completo</label>
                            <input type="text" id="nombreCompleto" readonly class="w-full px-4 py-3 border border-gray-200 rounded-lg bg-gray-50 text-gray-600 cursor-not-allowed">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Tipo de Pago *</label>
                            <select id="tipoPago" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                <option value="alicuota">Al√≠cuota Mensual</option>
                                <option value="agua">Consumo de Agua</option>
                                <option value="extraordinaria">Cuota Extraordinaria</option>
                                <option value="multa">Multa/Recargo</option>
                                <option value="otro">Otro Concepto</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Monto (USD) *</label>
                            <input type="number" id="monto" step="0.01" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="0.00">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Fecha de Pago *</label>
                            <input type="date" id="fechaPago" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Entidad Bancaria</label>
                            <input type="text" id="entidadBancaria" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="Ej: Banco Pichincha">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">N√∫mero de Comprobante</label>
                            <input type="text" id="numeroComprobante" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="Ej: 123456789">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Periodo (Mes/A√±o) *</label>
                            <input type="month" id="periodo" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div id="consumoAguaField" class="hidden">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Consumo (m¬≥)</label>
                            <input type="number" id="consumoAgua" step="0.01" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="0.00">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Observaciones</label>
                        <textarea id="observaciones" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="Detalles adicionales..."></textarea>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 rounded-lg transition duration-200 shadow-lg hover:shadow-xl">
                        üíæ Registrar Pago
                    </button>
                </form>
            </div>
        </div>

        <!-- Tab: Gestionar Copropietarios -->
        <div id="content-copropietarios" class="space-y-6 hidden">
            <div class="bg-white rounded-2xl shadow-lg p-6 slide-in">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Agregar Copropietario</h2>
                <form id="formCopropietario" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Nombres *</label>
                            <input type="text" id="nombres" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="Juan Carlos">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Apellidos *</label>
                            <input type="text" id="apellidos" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="P√©rez Garc√≠a">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">C√©dula *</label>
                            <input type="text" id="cedula" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="1234567890">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Departamento *</label>
                            <input type="text" id="departamento" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="101">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Bloque *</label>
                            <input type="text" id="bloque" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="A">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Tel√©fono</label>
                            <input type="tel" id="telefono" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="+593 99 999 9999">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Email</label>
                            <input type="email" id="email" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="correo@ejemplo.com">
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-lg transition duration-200 shadow-lg hover:shadow-xl">
                        ‚ûï Agregar Copropietario
                    </button>
                </form>
            </div>

            <div class="bg-white rounded-2xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Lista de Copropietarios</h2>
                    <div class="text-sm text-gray-500">
                        Total: <span id="totalCopropTabla" class="font-bold text-indigo-600">0</span>
                    </div>
                </div>
                <div class="mb-4">
                    <input type="text" id="buscarCoprop" class="w-full px-4 py-3 border border-gray-300 rounded-lg" placeholder="üîç Buscar por nombre, c√©dula o departamento...">
                </div>
                <div id="listaCopropietarios" class="overflow-x-auto"></div>
            </div>
        </div>

        <!-- Tab: Gesti√≥n Mensual -->
        <div id="content-gestion" class="space-y-6 hidden">
            <!-- Generar Expensas -->
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">üîÑ Generar Expensas Mensuales</h2>
                <p class="text-gray-600 mb-6">Genera autom√°ticamente un cargo de $22.00 por al√≠cuota para todos los copropietarios del mes seleccionado.</p>
                <div class="flex gap-4 items-end">
                    <div class="flex-1">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Periodo (Mes/A√±o)</label>
                        <input type="month" id="periodoExpensas" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <button onclick="generarExpensas()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-3 rounded-lg transition duration-200 shadow-lg hover:shadow-xl">
                        üöÄ Generar Expensas
                    </button>
                </div>
            </div>

            <!-- Registrar Consumo de Agua Masivo -->
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">üíß Registrar Consumo de Agua del Mes</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Periodo (Mes/A√±o)</label>
                        <input type="month" id="periodoAgua" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Precio por m¬≥ (USD)</label>
                        <input type="number" id="precioM3" step="0.01" value="0.50" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="0.50">
                    </div>
                    <div class="flex items-end">
                        <button onclick="cargarTablaAgua()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 rounded-lg transition">
                            üìã Cargar Tabla
                        </button>
                    </div>
                </div>
                <div id="tablaAgua" class="overflow-x-auto"></div>
                <div id="botonGuardarAgua" class="hidden mt-4">
                    <button onclick="guardarConsumoAgua()" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-lg transition shadow-lg hover:shadow-xl">
                        üíæ Guardar Todos los Consumos
                    </button>
                </div>
            </div>
        </div>

        <!-- Tab: Deudores -->
        <div id="content-deudores" class="space-y-6 hidden">
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">‚ö†Ô∏è Reporte de Deudores</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Filtrar por Bloque</label>
                        <select id="filtroDeudoresBloque" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Filtrar por Periodo</label>
                        <input type="month" id="filtroDeudoresPeriodo" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                    </div>
                    <div class="flex items-end">
                        <button onclick="renderDeudores()" class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 rounded-lg transition">
                            üîç Buscar Deudores
                        </button>
                    </div>
                </div>
                <div id="resumenDeudas" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6"></div>
                <div id="tablaDeudores" class="overflow-x-auto"></div>
            </div>
        </div>

        <!-- Tab: Historial de Pagos -->
        <div id="content-historial" class="space-y-6 hidden">
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Historial de Pagos</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Filtrar por Copropietario</label>
                        <select id="filtroHistorialCoprop" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Filtrar por Tipo</label>
                        <select id="filtroHistorialTipo" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                            <option value="">Todos</option>
                            <option value="alicuota">Al√≠cuota Mensual</option>
                            <option value="agua">Consumo de Agua</option>
                            <option value="extraordinaria">Cuota Extraordinaria</option>
                            <option value="multa">Multa/Recargo</option>
                            <option value="otro">Otro</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Periodo</label>
                        <input type="month" id="filtroPeriodo" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                    </div>
                </div>
                <div id="tablaHistorial" class="overflow-x-auto"></div>
            </div>
        </div>

        <!-- Tab: Resumen General -->
        <div id="content-resumen" class="space-y-6 hidden">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-2xl shadow-lg p-6 text-white">
                    <div class="text-sm opacity-90">Total Recaudado</div>
                    <div class="text-3xl font-bold mt-2" id="totalRecaudado">$0.00</div>
                </div>
                <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl shadow-lg p-6 text-white">
                    <div class="text-sm opacity-90">Pagos Este Mes</div>
                    <div class="text-3xl font-bold mt-2" id="pagosEsteMes">0</div>
                </div>
                <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-2xl shadow-lg p-6 text-white">
                    <div class="text-sm opacity-90">Deuda Total Pendiente</div>
                    <div class="text-3xl font-bold mt-2" id="deudaTotal">$0.00</div>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Estado de Cuenta por Copropietario</h2>
                <div id="resumenCopropietarios"></div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
        
        // Configuraci√≥n de Supabase
        const SUPABASE_URL = 'https://nofvsxiojrguldqieohk.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5vZnZzeGlvanJndWxkcWllb2hrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwMTE2MzMsImV4cCI6MjA4NjU4NzYzM30.yrd406gkL0u-KXnhEs4Iaiep22Np0uBC2z5IpFmrJSA';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Variables globales
        let copropietarios = [];
        let pagos = [];
        let expensas = [];

        // Cargar datos desde Supabase
        async function loadData() {
            try {
                const { data: copropData, error: copropError } = await supabase
                    .from('copropietarios')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (copropError) throw copropError;
                copropietarios = copropData || [];

                const { data: pagosData, error: pagosError } = await supabase
                    .from('pagos')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (pagosError) throw pagosError;
                pagos = pagosData || [];

                const { data: expensasData, error: expensasError } = await supabase
                    .from('expensas_mensuales')
                    .select('*')
                    .order('periodo', { ascending: false });
                
                if (expensasError) throw expensasError;
                expensas = expensasData || [];

                updateUI();
            } catch (error) {
                console.error('Error cargando datos:', error);
                alert('Error al cargar datos: ' + error.message);
            }
        }

        // Tab management
        window.showTab = function(tabName) {
            ['registro', 'copropietarios', 'gestion', 'deudores', 'historial', 'resumen'].forEach(tab => {
                const content = document.getElementById(`content-${tab}`);
                const tabBtn = document.getElementById(`tab-${tab}`);
                if (content && tabBtn) {
                    content.classList.add('hidden');
                    tabBtn.classList.remove('text-indigo-600', 'border-b-2', 'border-indigo-600');
                    tabBtn.classList.add('text-gray-500');
                }
            });
            
            const activeContent = document.getElementById(`content-${tabName}`);
            const activeTab = document.getElementById(`tab-${tabName}`);
            if (activeContent && activeTab) {
                activeContent.classList.remove('hidden');
                activeTab.classList.add('text-indigo-600', 'border-b-2', 'border-indigo-600');
                activeTab.classList.remove('text-gray-500');
            }
            
            if (tabName === 'historial') renderHistorial();
            if (tabName === 'resumen') renderResumen();
            if (tabName === 'deudores') renderDeudores();
        }

        // Copropietario form
        document.getElementById('formCopropietario').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const nuevoCoprop = {
                nombres: document.getElementById('nombres').value,
                apellidos: document.getElementById('apellidos').value,
                cedula: document.getElementById('cedula').value,
                departamento: document.getElementById('departamento').value,
                bloque: document.getElementById('bloque').value,
                telefono: document.getElementById('telefono').value || null,
                email: document.getElementById('email').value || null
            };
            
            try {
                const { data, error } = await supabase
                    .from('copropietarios')
                    .insert([nuevoCoprop])
                    .select();
                
                if (error) throw error;
                
                e.target.reset();
                await loadData();
                alert('‚úÖ Copropietario agregado exitosamente');
            } catch (error) {
                console.error('Error:', error);
                if (error.code === '23505') {
                    alert('‚ùå Esta c√©dula ya est√° registrada');
                } else {
                    alert('‚ùå Error al agregar copropietario: ' + error.message);
                }
            }
        });

        // Pago form
        document.getElementById('formPago').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const copropietarioId = document.getElementById('selectDepartamento').value;
            if (!copropietarioId) {
                alert('‚ùå Por favor seleccione un departamento');
                return;
            }
            
            const nuevoPago = {
                copropietario_id: copropietarioId,
                tipo: document.getElementById('tipoPago').value,
                monto: parseFloat(document.getElementById('monto').value),
                fecha: document.getElementById('fechaPago').value,
                entidad_bancaria: document.getElementById('entidadBancaria').value || null,
                numero_comprobante: document.getElementById('numeroComprobante').value || null,
                periodo: document.getElementById('periodo').value,
                observaciones: document.getElementById('observaciones').value || null,
                consumo_agua: document.getElementById('consumoAgua').value ? 
                    parseFloat(document.getElementById('consumoAgua').value) : null
            };
            
            try {
                const { data, error } = await supabase
                    .from('pagos')
                    .insert([nuevoPago])
                    .select();
                
                if (error) throw error;
                
                // Marcar expensa como pagada si aplica
                if (nuevoPago.tipo === 'alicuota' || nuevoPago.tipo === 'agua') {
                    await marcarExpensaPagada(copropietarioId, nuevoPago.periodo);
                }
                
                e.target.reset();
                document.getElementById('nombreCompleto').value = '';
                document.getElementById('consumoAguaField').classList.add('hidden');
                await loadData();
                alert('‚úÖ Pago registrado exitosamente');
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Error al registrar pago: ' + error.message);
            }
        });

        // Marcar expensa como pagada
        async function marcarExpensaPagada(copropietarioId, periodo) {
            try {
                const { error } = await supabase
                    .from('expensas_mensuales')
                    .update({ pagado: true, fecha_pago: new Date().toISOString() })
                    .eq('copropietario_id', copropietarioId)
                    .eq('periodo', periodo);
                
                if (error) console.error('Error marcando expensa:', error);
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // Generar expensas mensuales
        window.generarExpensas = async function() {
            const periodo = document.getElementById('periodoExpensas').value;
            if (!periodo) {
                alert('‚ùå Por favor seleccione un periodo');
                return;
            }

            if (!confirm(`¬øGenerar expensas de $22 para todos los copropietarios del periodo ${periodo}?`)) {
                return;
            }

            try {
                const { data, error } = await supabase.rpc('generar_expensas_mes', {
                    periodo_input: periodo
                });

                if (error) throw error;

                await loadData();
                alert(`‚úÖ Se generaron ${data} expensas exitosamente`);
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Error al generar expensas: ' + error.message);
            }
        }

        // Cargar tabla de agua
        window.cargarTablaAgua = function() {
            const periodo = document.getElementById('periodoAgua').value;
            const precioM3 = parseFloat(document.getElementById('precioM3').value);

            if (!periodo || !precioM3) {
                alert('‚ùå Complete el periodo y precio por m¬≥');
                return;
            }

            const sorted = [...copropietarios].sort((a, b) => {
                if (a.bloque !== b.bloque) return a.bloque.localeCompare(b.bloque);
                return a.departamento.localeCompare(b.departamento);
            });

            const tabla = document.getElementById('tablaAgua');
            tabla.innerHTML = `
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-semibold">Bloque</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold">Depto</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold">Copropietario</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold">Consumo (m¬≥)</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold">Monto (USD)</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        ${sorted.map(c => `
                            <tr data-coprop-id="${c.id}">
                                <td class="px-4 py-3 font-bold text-indigo-600">${c.bloque}</td>
                                <td class="px-4 py-3 font-bold text-indigo-600">${c.departamento}</td>
                                <td class="px-4 py-3">${c.nombres} ${c.apellidos}</td>
                                <td class="px-4 py-3">
                                    <input type="number" step="0.01" class="consumo-input w-24 px-2 py-1 border rounded" 
                                           data-coprop-id="${c.id}" onchange="calcularMontoAgua(this, ${precioM3})">
                                </td>
                                <td class="px-4 py-3">
                                    <span class="monto-display font-bold text-green-600">$0.00</span>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            document.getElementById('botonGuardarAgua').classList.remove('hidden');
        }

        window.calcularMontoAgua = function(input, precioM3) {
            const row = input.closest('tr');
            const consumo = parseFloat(input.value) || 0;
            const monto = consumo * precioM3;
            row.querySelector('.monto-display').textContent = `$${monto.toFixed(2)}`;
        }

        window.guardarConsumoAgua = async function() {
            const periodo = document.getElementById('periodoAgua').value;
            const precioM3 = parseFloat(document.getElementById('precioM3').value);
            
            const inputs = document.querySelectorAll('.consumo-input');
            const registros = [];

            inputs.forEach(input => {
                const consumo = parseFloat(input.value) || 0;
                if (consumo > 0) {
                    const copropId = input.dataset.copropId;
                    const monto = consumo * precioM3;
                    registros.push({
                        copropietario_id: copropId,
                        consumo_m3: consumo,
                        monto: monto
                    });
                }
            });

            if (registros.length === 0) {
                alert('‚ùå No hay consumos registrados');
                return;
            }

            if (!confirm(`¬øGuardar ${registros.length} consumos de agua?`)) {
                return;
            }

            try {
                // Actualizar expensas existentes
                for (const reg of registros) {
                    const { error } = await supabase
                        .from('expensas_mensuales')
                        .update({
                            consumo_agua_m3: reg.consumo_m3,
                            monto_agua: reg.monto,
                            total: supabase.sql`monto_alicuota + ${reg.monto}`
                        })
                        .eq('copropietario_id', reg.copropietario_id)
                        .eq('periodo', periodo);

                    if (error) throw error;
                }

                await loadData();
                alert(`‚úÖ Se guardaron ${registros.length} consumos de agua`);
                document.getElementById('tablaAgua').innerHTML = '';
                document.getElementById('botonGuardarAgua').classList.add('hidden');
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Error al guardar consumos: ' + error.message);
            }
        }

        // Renderizar deudores
        window.renderDeudores = async function() {
            const bloque = document.getElementById('filtroDeudoresBloque').value;
            const periodo = document.getElementById('filtroDeudoresPeriodo').value;

            try {
                let query = supabase
                    .from('expensas_mensuales')
                    .select(`
                        *,
                        copropietarios (*)
                    `)
                    .eq('pagado', false);

                if (periodo) query = query.eq('periodo', periodo);

                const { data, error } = await query;
                if (error) throw error;

                let deudores = data || [];
                
                if (bloque) {
                    deudores = deudores.filter(d => d.copropietarios.bloque === bloque);
                }

                // Calcular resumen
                const totalDeuda = deudores.reduce((sum, d) => sum + parseFloat(d.total), 0);
                const totalDeudores = new Set(deudores.map(d => d.copropietario_id)).size;

                document.getElementById('resumenDeudas').innerHTML = `
                    <div class="bg-red-100 rounded-lg p-4">
                        <div class="text-sm text-red-600">Total Deudores</div>
                        <div class="text-2xl font-bold text-red-700">${totalDeudores}</div>
                    </div>
                    <div class="bg-orange-100 rounded-lg p-4">
                        <div class="text-sm text-orange-600">Expensas Vencidas</div>
                        <div class="text-2xl font-bold text-orange-700">${deudores.length}</div>
                    </div>
                    <div class="bg-yellow-100 rounded-lg p-4">
                        <div class="text-sm text-yellow-600">Deuda Total</div>
                        <div class="text-2xl font-bold text-yellow-700">$${totalDeuda.toFixed(2)}</div>
                    </div>
                `;

                const tabla = document.getElementById('tablaDeudores');
                if (deudores.length === 0) {
                    tabla.innerHTML = '<div class="text-center text-gray-500 py-8">‚úÖ No hay deudores</div>';
                    return;
                }

                tabla.innerHTML = `
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-semibold">Bloque</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold">Depto</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold">Copropietario</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold">Periodo</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold">Al√≠cuota</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold">Agua</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold">Total Deuda</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold">Contacto</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            ${deudores.map(d => `
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-3 font-bold text-indigo-600">${d.copropietarios.bloque}</td>
                                    <td class="px-4 py-3 font-bold text-indigo-600">${d.copropietarios.departamento}</td>
                                    <td class="px-4 py-3">${d.copropietarios.nombres} ${d.copropietarios.apellidos}</td>
                                    <td class="px-4 py-3">${new Date(d.periodo + '-01').toLocaleDateString('es-EC', {month: 'short', year: 'numeric'})}</td>
                                    <td class="px-4 py-3">$${parseFloat(d.monto_alicuota).toFixed(2)}</td>
                                    <td class="px-4 py-3">${d.monto_agua ? `$${parseFloat(d.monto_agua).toFixed(2)}` : '-'}</td>
                                    <td class="px-4 py-3 font-bold text-red-600">$${parseFloat(d.total).toFixed(2)}</td>
                                    <td class="px-4 py-3 text-sm">
                                        ${d.copropietarios.telefono ? `üì± ${d.copropietarios.telefono}` : '-'}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Error al cargar deudores: ' + error.message);
            }
        }

        // Update UI
        function updateUI() {
            document.getElementById('totalCopropietarios').textContent = copropietarios.length;
            
            const selectDepto = document.getElementById('selectDepartamento');
            const selectHistorial = document.getElementById('filtroHistorialCoprop');
            const filtroBloque = document.getElementById('filtroDeudoresBloque');
            
            selectDepto.innerHTML = '<option value="">Seleccione un departamento</option>';
            selectHistorial.innerHTML = '<option value="">Todos</option>';
            
            const bloques = new Set(copropietarios.map(c => c.bloque));
            filtroBloque.innerHTML = '<option value="">Todos</option>' + 
                Array.from(bloques).sort().map(b => `<option value="${b}">${b}</option>`).join('');
            
            const sorted = [...copropietarios].sort((a, b) => {
                if (a.bloque !== b.bloque) return a.bloque.localeCompare(b.bloque);
                return a.departamento.localeCompare(b.departamento);
            });
            
            sorted.forEach(c => {
                const displayDepto = `Bloque ${c.bloque} - Depto ${c.departamento}`;
                const displayHistorial = `${c.nombres} ${c.apellidos} - Bloque ${c.bloque} Depto ${c.departamento}`;
                selectDepto.innerHTML += `<option value="${c.id}">${displayDepto}</option>`;
                selectHistorial.innerHTML += `<option value="${c.id}">${displayHistorial}</option>`;
            });
            
            renderCopropietarios();
        }
        
        document.getElementById('selectDepartamento').addEventListener('change', function() {
            const copropId = this.value;
            const nombreField = document.getElementById('nombreCompleto');
            
            if (copropId) {
                const coprop = copropietarios.find(c => c.id === copropId);
                if (coprop) {
                    nombreField.value = `${coprop.nombres} ${coprop.apellidos}`;
                }
            } else {
                nombreField.value = '';
            }
        });

        function renderCopropietarios() {
            const lista = document.getElementById('listaCopropietarios');
            const busqueda = document.getElementById('buscarCoprop').value.toLowerCase();
            
            const filtrados = copropietarios.filter(c => 
                c.nombres.toLowerCase().includes(busqueda) || 
                c.apellidos.toLowerCase().includes(busqueda) ||
                c.cedula.includes(busqueda) ||
                c.departamento.toLowerCase().includes(busqueda) ||
                c.bloque.toLowerCase().includes(busqueda)
            );
            
            document.getElementById('totalCopropTabla').textContent = filtrados.length;
            
            if (filtrados.length === 0) {
                lista.innerHTML = '<div class="text-center text-gray-500 py-8">No hay copropietarios registrados</div>';
                return;
            }
            
            const copropietariosConStats = filtrados.map(c => {
                const pagosCoprop = pagos.filter(p => p.copropietario_id === c.id);
                const totalPagado = pagosCoprop.reduce((sum, p) => sum + parseFloat(p.monto), 0);
                const ultimoPago = pagosCoprop.length > 0 ? 
                    new Date(Math.max(...pagosCoprop.map(p => new Date(p.fecha)))) : null;
                const totalConsumoAgua = pagosCoprop
                    .filter(p => p.tipo === 'agua' && p.consumo_agua)
                    .reduce((sum, p) => sum + parseFloat(p.consumo_agua), 0);
                
                return {
                    ...c,
                    cantidadPagos: pagosCoprop.length,
                    totalPagado,
                    ultimoPago,
                    totalConsumoAgua
                };
            });
            
            lista.innerHTML = `
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Nombres</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Apellidos</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">C√©dula</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Bloque</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Depto</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Contacto</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Total Pagado</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700"># Pagos</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        ${copropietariosConStats.map(c => `
                            <tr class="hover:bg-gray-50 transition">
                                <td class="px-4 py-3 font-semibold text-gray-800">${c.nombres}</td>
                                <td class="px-4 py-3 font-semibold text-gray-800">${c.apellidos}</td>
                                <td class="px-4 py-3 text-sm text-gray-600">${c.cedula}</td>
                                <td class="px-4 py-3 font-bold text-indigo-600">${c.bloque}</td>
                                <td class="px-4 py-3 font-bold text-indigo-600">${c.departamento}</td>
                                <td class="px-4 py-3 text-sm">
                                    ${c.telefono ? `<div class="text-gray-600">üì± ${c.telefono}</div>` : ''}
                                    ${c.email ? `<div class="text-gray-600 text-xs">üìß ${c.email}</div>` : ''}
                                    ${!c.telefono && !c.email ? '<span class="text-gray-400">-</span>' : ''}
                                </td>
                                <td class="px-4 py-3 font-bold text-green-600">$${c.totalPagado.toFixed(2)}</td>
                                <td class="px-4 py-3 text-center">
                                    <span class="inline-block bg-indigo-100 text-indigo-800 px-3 py-1 rounded-full text-sm font-semibold">
                                        ${c.cantidadPagos}
                                    </span>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function renderHistorial() {
            let pagosFiltrados = [...pagos];
            
            const copropId = document.getElementById('filtroHistorialCoprop').value;
            const tipo = document.getElementById('filtroHistorialTipo').value;
            const periodo = document.getElementById('filtroPeriodo').value;
            
            if (copropId) pagosFiltrados = pagosFiltrados.filter(p => p.copropietario_id === copropId);
            if (tipo) pagosFiltrados = pagosFiltrados.filter(p => p.tipo === tipo);
            if (periodo) pagosFiltrados = pagosFiltrados.filter(p => p.periodo === periodo);
            
            pagosFiltrados.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            
            const tabla = document.getElementById('tablaHistorial');
            
            if (pagosFiltrados.length === 0) {
                tabla.innerHTML = '<div class="text-center text-gray-500 py-8">No hay pagos registrados</div>';
                return;
            }
            
            tabla.innerHTML = `
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Fecha</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Copropietario</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Tipo</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Monto</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Entidad</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Comprobante</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Periodo</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        ${pagosFiltrados.map(p => {
                            const coprop = copropietarios.find(c => c.id === p.copropietario_id);
                            const tipoLabels = {
                                alicuota: 'Al√≠cuota',
                                agua: 'Consumo Agua',
                                extraordinaria: 'Extraordinaria',
                                multa: 'Multa',
                                otro: 'Otro'
                            };
                            return `
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-3 text-sm">${new Date(p.fecha).toLocaleDateString('es-EC')}</td>
                                    <td class="px-4 py-3 text-sm font-medium">${coprop ? `${coprop.nombres} ${coprop.apellidos} (${coprop.bloque}-${coprop.departamento})` : 'N/A'}</td>
                                    <td class="px-4 py-3 text-sm">${tipoLabels[p.tipo]}</td>
                                    <td class="px-4 py-3 text-sm font-bold text-green-600">$${parseFloat(p.monto).toFixed(2)}</td>
                                    <td class="px-4 py-3 text-sm text-gray-600">${p.entidad_bancaria || '-'}</td>
                                    <td class="px-4 py-3 text-sm text-gray-600">${p.numero_comprobante || '-'}</td>
                                    <td class="px-4 py-3 text-sm">${p.periodo ? new Date(p.periodo + '-01').toLocaleDateString('es-EC', {month: 'short', year: 'numeric'}) : 'N/A'}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        function renderResumen() {
            const totalRecaudado = pagos.reduce((sum, p) => sum + parseFloat(p.monto), 0);
            const mesActual = new Date().toISOString().slice(0, 7);
            const pagosEsteMes = pagos.filter(p => p.fecha.startsWith(mesActual)).length;
            const deudaTotal = expensas.filter(e => !e.pagado).reduce((sum, e) => sum + parseFloat(e.total), 0);
            
            document.getElementById('totalRecaudado').textContent = `$${totalRecaudado.toFixed(2)}`;
            document.getElementById('pagosEsteMes').textContent = pagosEsteMes;
            document.getElementById('deudaTotal').textContent = `$${deudaTotal.toFixed(2)}`;
            
            const resumen = document.getElementById('resumenCopropietarios');
            resumen.innerHTML = copropietarios.map(c => {
                const pagosCoprop = pagos.filter(p => p.copropietario_id === c.id);
                const totalPagado = pagosCoprop.reduce((sum, p) => sum + parseFloat(p.monto), 0);
                const deudaCoprop = expensas.filter(e => e.copropietario_id === c.id && !e.pagado)
                    .reduce((sum, e) => sum + parseFloat(e.total), 0);
                const ultimoPago = pagosCoprop.length > 0 ? 
                    new Date(Math.max(...pagosCoprop.map(p => new Date(p.fecha)))).toLocaleDateString('es-EC') : 
                    'Sin pagos';
                
                return `
                    <div class="border border-gray-200 rounded-lg p-4 mb-4 hover:shadow-md transition">
                        <div class="flex justify-between items-center">
                            <div>
                                <div class="font-bold text-lg">${c.nombres} ${c.apellidos}</div>
                                <div class="text-sm text-gray-600">üè† Bloque ${c.bloque} - Depto ${c.departamento}</div>
                                <div class="text-sm text-gray-500 mt-1">√öltimo pago: ${ultimoPago}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm text-gray-500">Total Pagado</div>
                                <div class="text-2xl font-bold text-green-600">$${totalPagado.toFixed(2)}</div>
                                ${deudaCoprop > 0 ? `<div class="text-sm text-red-600 font-semibold mt-1">Debe: $${deudaCoprop.toFixed(2)}</div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Event listeners
        document.getElementById('buscarCoprop').addEventListener('input', renderCopropietarios);
        document.getElementById('filtroHistorialCoprop').addEventListener('change', renderHistorial);
        document.getElementById('filtroHistorialTipo').addEventListener('change', renderHistorial);
        document.getElementById('filtroPeriodo').addEventListener('change', renderHistorial);

        // Tab button event listeners
        document.getElementById('tab-registro').addEventListener('click', () => showTab('registro'));
        document.getElementById('tab-copropietarios').addEventListener('click', () => showTab('copropietarios'));
        document.getElementById('tab-gestion').addEventListener('click', () => showTab('gestion'));
        document.getElementById('tab-deudores').addEventListener('click', () => showTab('deudores'));
        document.getElementById('tab-historial').addEventListener('click', () => showTab('historial'));
        document.getElementById('tab-resumen').addEventListener('click', () => showTab('resumen'));

        // Show/hide water consumption field
        document.getElementById('tipoPago').addEventListener('change', function() {
            const consumoField = document.getElementById('consumoAguaField');
            if (this.value === 'agua') {
                consumoField.classList.remove('hidden');
            } else {
                consumoField.classList.add('hidden');
                document.getElementById('consumoAgua').value = '';
            }
        });

        // Set default dates
        document.getElementById('fechaPago').valueAsDate = new Date();
        const currentMonth = new Date().toISOString().slice(0, 7);
        document.getElementById('periodo').value = currentMonth;
        document.getElementById('periodoExpensas').value = currentMonth;
        document.getElementById('periodoAgua').value = currentMonth;

        // Load data on start
        loadData();
        
        }); // End DOMContentLoaded
    </script>
</body>
</html>
