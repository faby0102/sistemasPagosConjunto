<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Pagos - Conjunto Habitacional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
    </style>
</head>

<body class="bg-gradient-to-br from-blue-50 to-indigo-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6 slide-in">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">üíº Sistema de Pagos</h1>
                    <p class="text-gray-600 mt-1">Gesti√≥n de Copropietarios - Conjunto Habitacional</p>
                    <div class="mt-2 text-sm text-green-600 font-semibold">üü¢ Conectado a Base de Datos</div>
                </div>
                <div class="text-right">
                    <div class="text-sm text-gray-500">Total Copropietarios</div>
                    <div class="text-3xl font-bold text-indigo-600" id="totalCopropietarios">0</div>
                </div>
            </div>
        </div>

        <!-- Tabs Navigation -->
        <div class="bg-white rounded-2xl shadow-lg mb-6 slide-in" style="animation-delay: 0.1s;">
            <div class="flex flex-wrap border-b">
                <button id="tab-registro"
                    class="flex-1 px-4 py-4 font-semibold text-indigo-600 border-b-2 border-indigo-600 min-w-[120px]">
                    üìù Registrar Pago
                </button>
                <button id="tab-copropietarios"
                    class="flex-1 px-4 py-4 font-semibold text-gray-500 hover:text-gray-700 min-w-[120px]">
                    üë• Copropietarios
                </button>
                <button id="tab-historial"
                    class="flex-1 px-4 py-4 font-semibold text-gray-500 hover:text-gray-700 min-w-[120px]">
                    üìä Historial
                </button>
                <button id="tab-resumen"
                    class="flex-1 px-4 py-4 font-semibold text-gray-500 hover:text-gray-700 min-w-[120px]">
                    üìà Resumen
                </button>
            </div>
        </div>

        <!-- Tab: Registrar Pago -->
        <div id="content-registro" class="space-y-6">
            <div class="bg-white rounded-2xl shadow-lg p-6 slide-in">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Registrar Nuevo Pago</h2>
                <form id="formPago" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Departamento *</label>
                            <input type="text" id="selectDepartamento" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                placeholder="Ej: 101">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Tipo de Pago *</label>
                            <select id="tipoPago" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                <option value="alicuota">Al√≠cuota Mensual</option>
                                <option value="agua">Consumo de Agua</option>
                                <option value="extraordinaria">Cuota Extraordinaria</option>
                                <option value="multa">Multa/Recargo</option>
                                <option value="otro">Otro Concepto</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Monto (USD) *</label>
                            <input type="number" id="monto" step="0.01" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                placeholder="0.00">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Fecha de Pago *</label>
                            <input type="date" id="fechaPago" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>
                    <button type="submit"
                        class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 rounded-lg transition duration-200 shadow-lg hover:shadow-xl">
                        üíæ Registrar Pago
                    </button>
                </form>
            </div>
        </div>

        <!-- Tab: Gestionar Copropietarios -->
        <div id="content-copropietarios" class="space-y-6 hidden">
            <div class="bg-white rounded-2xl shadow-lg p-6 slide-in">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Agregar Copropietario</h2>
                <form id="formCopropietario" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Nombres *</label>
                            <input type="text" id="nombres" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                placeholder="Juan Carlos">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Apellidos *</label>
                            <input type="text" id="apellidos" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                placeholder="P√©rez Garc√≠a">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">C√©dula * (10 d√≠gitos)</label>
                            <input type="text" id="cedula" required maxlength="10" pattern="[0-9]{10}"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                placeholder="1234567890">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Departamento *</label>
                            <input type="text" id="departamento" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                placeholder="101">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Bloque *</label>
                            <input type="text" id="bloque" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                placeholder="A">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Tel√©fono</label>
                            <input type="tel" id="telefono"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                placeholder="+593 99 999 9999">
                        </div>
                    </div>
                    <button type="submit"
                        class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-lg transition duration-200 shadow-lg hover:shadow-xl">
                        ‚ûï Agregar Copropietario
                    </button>
                </form>
            </div>

            <div class="bg-white rounded-2xl shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Lista de Copropietarios</h2>
                <div id="listaCopropietarios"></div>
            </div>
        </div>

        <!-- Tab: Historial de Pagos -->
        <div id="content-historial" class="space-y-6 hidden">
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Historial de Pagos</h2>
                <div id="tablaHistorial"></div>
            </div>
        </div>

        <!-- Tab: Resumen General -->
        <div id="content-resumen" class="space-y-6 hidden">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-2xl shadow-lg p-6 text-white">
                    <div class="text-sm opacity-90">Total Recaudado</div>
                    <div class="text-3xl font-bold mt-2" id="totalRecaudado">$0.00</div>
                </div>
                <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl shadow-lg p-6 text-white">
                    <div class="text-sm opacity-90">Pagos Este Mes</div>
                    <div class="text-3xl font-bold mt-2" id="pagosEsteMes">0</div>
                </div>
                <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-2xl shadow-lg p-6 text-white">
                    <div class="text-sm opacity-90">Deuda Total Pendiente</div>
                    <div class="text-3xl font-bold mt-2" id="deudaTotal">$0.00</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuraci√≥n de Supabase
        const SUPABASE_URL = 'https://nofvsxiojrguldqieohk.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5vZnZzeGlvanJndWxkcWllb2hrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwMTE2MzMsImV4cCI6MjA4NjU4NzYzM30.yrd406gkL0u-KXnhEs4Iaiep22Np0uBC2z5IpFmrJSA';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Variables globales
        let copropietarios = [];
        let pagos = [];

        // Tab management
        function showTab(tabName) {
            console.log('Switching to tab:', tabName);

            // Hide all tabs
            ['registro', 'copropietarios', 'historial', 'resumen'].forEach(tab => {
                const content = document.getElementById(`content-${tab}`);
                const tabBtn = document.getElementById(`tab-${tab}`);
                if (content) {
                    content.classList.add('hidden');
                }
                if (tabBtn) {
                    tabBtn.classList.remove('text-indigo-600', 'border-b-2', 'border-indigo-600');
                    tabBtn.classList.add('text-gray-500');
                }
            });

            // Show active tab
            const activeContent = document.getElementById(`content-${tabName}`);
            const activeTab = document.getElementById(`tab-${tabName}`);

            if (activeContent) {
                activeContent.classList.remove('hidden');
                console.log('Content shown:', tabName);
            }

            if (activeTab) {
                activeTab.classList.add('text-indigo-600', 'border-b-2', 'border-indigo-600');
                activeTab.classList.remove('text-gray-500');
                console.log('Tab button activated:', tabName);
            }

            // Render specific content
            if (tabName === 'historial') renderHistorial();
            if (tabName === 'resumen') renderResumen();
            if (tabName === 'copropietarios') renderCopropietarios();
        }

        // Cargar datos desde Supabase
        async function loadData() {
            try {
                const { data: copropData, error: copropError } = await supabase
                    .from('copropietarios')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (copropError) throw copropError;
                copropietarios = copropData || [];

                const { data: pagosData, error: pagosError } = await supabase
                    .from('pagos')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (pagosError) throw pagosError;
                pagos = pagosData || [];

                updateUI();
            } catch (error) {
                console.error('Error cargando datos:', error);
                alert('Error al cargar datos: ' + error.message);
            }
        }

        // Update UI
        function updateUI() {
            document.getElementById('totalCopropietarios').textContent = copropietarios.length;
        }

        function renderCopropietarios() {
            const lista = document.getElementById('listaCopropietarios');

            if (copropietarios.length === 0) {
                lista.innerHTML = '<div class="text-center text-gray-500 py-8">No hay copropietarios registrados</div>';
                return;
            }

            lista.innerHTML = `
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-semibold">Nombres</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold">Apellidos</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold">C√©dula</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold">Bloque</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold">Depto</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        ${copropietarios.map(c => `
                            <tr class="hover:bg-gray-50">
                                <td class="px-4 py-3">${c.nombres}</td>
                                <td class="px-4 py-3">${c.apellidos}</td>
                                <td class="px-4 py-3">${c.cedula}</td>
                                <td class="px-4 py-3 font-bold text-indigo-600">${c.bloque}</td>
                                <td class="px-4 py-3 font-bold text-indigo-600">${c.departamento}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function renderHistorial() {
            const tabla = document.getElementById('tablaHistorial');

            if (pagos.length === 0) {
                tabla.innerHTML = '<div class="text-center text-gray-500 py-8">No hay pagos registrados</div>';
                return;
            }

            tabla.innerHTML = `
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-semibold">Fecha</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold">Tipo</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold">Monto</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        ${pagos.map(p => `
                            <tr class="hover:bg-gray-50">
                                <td class="px-4 py-3">${new Date(p.fecha).toLocaleDateString('es-EC')}</td>
                                <td class="px-4 py-3">${p.tipo}</td>
                                <td class="px-4 py-3 font-bold text-green-600">$${parseFloat(p.monto).toFixed(2)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function renderResumen() {
            const totalRecaudado = pagos.reduce((sum, p) => sum + parseFloat(p.monto), 0);
            const mesActual = new Date().toISOString().slice(0, 7);
            const pagosEsteMes = pagos.filter(p => p.fecha.startsWith(mesActual)).length;

            document.getElementById('totalRecaudado').textContent = `$${totalRecaudado.toFixed(2)}`;
            document.getElementById('pagosEsteMes').textContent = pagosEsteMes;
            document.getElementById('deudaTotal').textContent = '$0.00';
        }

        // Form handlers
        document.getElementById('formCopropietario').addEventListener('submit', async (e) => {
            e.preventDefault();

            const nuevoCoprop = {
                nombres: document.getElementById('nombres').value,
                apellidos: document.getElementById('apellidos').value,
                cedula: document.getElementById('cedula').value,
                departamento: document.getElementById('departamento').value,
                bloque: document.getElementById('bloque').value,
                telefono: document.getElementById('telefono').value || null
            };

            try {
                const { data, error } = await supabase
                    .from('copropietarios')
                    .insert([nuevoCoprop])
                    .select();

                if (error) throw error;

                e.target.reset();
                await loadData();
                alert('‚úÖ Copropietario agregado exitosamente');
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Error al agregar copropietario: ' + error.message);
            }
        });

        document.getElementById('formPago').addEventListener('submit', async (e) => {
            e.preventDefault();

            alert('‚ö†Ô∏è Funci√≥n de pago en desarrollo. Por favor complete la implementaci√≥n.');
        });

        // Event listeners for tab buttons
        document.getElementById('tab-registro').addEventListener('click', () => showTab('registro'));
        document.getElementById('tab-copropietarios').addEventListener('click', () => showTab('copropietarios'));
        document.getElementById('tab-historial').addEventListener('click', () => showTab('historial'));
        document.getElementById('tab-resumen').addEventListener('click', () => showTab('resumen'));

        // Set default date
        document.getElementById('fechaPago').valueAsDate = new Date();

        // Load data on start
        loadData();
    </script>
</body>

</html>
